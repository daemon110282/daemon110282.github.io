# Two-factor authentication (2FA)

## Зачем

- Повысить безопасноть
- Метод защиты данных, при котором для входа в систему применяется два независимых способа подтверждения личности.

## Паттерны

- OTP
  - SMS
  - Push
    - Если пользователь вошел в приложение на другом устройстве, ему отправляется push-уведомление.
    - Он может подтвердить вход одним нажатием.
    - Требует наличия доверенного устройства.
  - [Email](#email)
  - FlashCall Верификация через звонок
- [Резервные (одноразовые) коды](#резервные-одноразовые-коды)
- Аутентификация через приложение (TOTP)
- HMAC based OTP (HOTP)
- Time based OTP (TOTP) ![schema](https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb885be28-b049-48fc-ad76-7416314dd4c3_3096x3603.jpeg)
- Passwordless [Биометрия](#биометрия) (Face ID, Touch ID)
  - сдал биометрию в отделениях __банков или через приложение Госуслуг__
- [PIN ПИН код](#pin)
- Поддержка и верификация личности

### Резервные (одноразовые) коды

Резервные коды – это заранее сгенерированные одноразовые пароли, которые пользователь может использовать для входа, если не может получить SMS-код или использовать другие методы 2FA.

Алгоритм:

1. Генерация и хранение кодов
При включении 2FA система генерирует несколько (обычно 5–10) уникальных одноразовых кодов.
Коды отображаются пользователю один раз (например, в виде списка) с предложением их сохранить в безопасном месте.
Каждый код можно использовать только один раз.

2. Использование резервных кодов
Если пользователь не может получить SMS или код из приложения-аутентификатора, он выбирает опцию «Использовать резервный код».
Вводит один из ранее сохраненных кодов.
Если код корректный, пользователь получает доступ.
  __Интернет нужен для проверки кода__ Сервер должен убедиться, что введенный код:
    Существует в базе резервных кодов пользователя.
    Еще не был использован (так как каждый код одноразовый).
    Принадлежит правильному аккаунту.
Код, который использовался, больше недействителен.

3. Обновление резервных кодов
Если у пользователя заканчиваются коды, он может запросить новый набор (обычно после входа в аккаунт).
Новый список заменяет старые коды.
Пользователь снова должен сохранить их в надежном месте.

### Email

### Беспарольные методы

- Passwordless authentication означает, что пользователь может подтвердить доступ к приложению или IT-системе, __не предоставляя пароль и не отвечая на секретные вопросы__
- К беспарольным методам относится
  - биометрия (вход в систему по отпечатку пальца, сердцебиению, походке, клавиатурному почерку, сетчатке, голосу, лицу и так далее).
  - по [QR-коду](qr.md) (как в Telegram)
  - с помощью push-сообщения
- На уровне устройств, браузеров может быть реализована по протоколу [WebAuthn](../../../technology/protocols.integration/webauthn.md), FIDO2\CTAP2

### PIN

Use Case:

- установить PIN
  - [пример реализации React](https://blog.openreplay.com/securing-pin-input/)
  - Пользователь вводит PIN дважды
  - Ограничьте длину PIN (4-8)
- вход по PIN
  - ограничьте число попыток ввода PIN
- изменить\сбросить PIN
- уведомления о входе на новом устройстве
- (не)доверенные устройства

[ИБ рекомендации TODO](https://fi5t.xyz/posts/pin-code-authentication-rfc/)

#### Локальная валидация PIN

- PIN-код хранится в
  - __хешированном виде с солью__
    - соль: ид сессии + [deviceid](../../../technology/fingerprint.md)
  - или Web Crypto API для __шифрования__ PIN (например, с ключом, основанным на устройстве)
    - PIN зашифруем с помощью AES-GCM, используя ключ, связанный с устройством (или сессией)
    - Храним:
      - зашифрованный PIN (ciphertext)
      - iv (вектор инициализации)
    - Ключ храним в session-only памяти — он исчезает при перезапуске вкладки или браузера
    - Расшифровка PIN происходит только при вводе.
  - или zero-knowledge security - шифрование токенов\данных, можно использовать короткие ПИНы (перебор усложнен из за PBKDF2)
    - Из PIN и соли генерируется ключ через хэш функцию Password-Based Key Derivation Function [__PBKDF2__](https://www.securitylab.ru/analytics/427930.php)
    - Ключ используется для AES-GCM шифрования данных (например, access token)
    - Зашифрованные данные + соль + iv сохраняются в localStorage
    - При вводе PIN — дешифруем и восстанавливаем access\refresh token
- В браузере и сохраняется в LocalStorage или IndexedDB (безопаснее от угроз XSS)
- При совпадении — отправляется refresh token или сохранённый access token на сервер
- PIN используется для локального доступа (например, дешифровки токена)
- Срок жизни ПИН  
  - критичен, потому что
    - PIN — слабый фактор (обычно 4–6 цифр)
    - PIN не защищён как пароли
    - Долгая сессия + бесконечный PIN = уязвимость
  - ограничить таймаут для блокировки и входа по ПИН
  - не заставлять пользователя менять PIN сам по себе, если не было взлома или подозрительной активности.

#### Серверная валидация PIN

- example [LoginRadius API](https://www.loginradius.com/legacy/docs/api/v2/customer-identity-api/pin-authentication/overview/#partdeployment2) Use Case:
  - Set PIN
    - During the registration, the application prompts your customer to set a PIN for the account
    - existing customers are prompted to set a PIN during the login
  - Change PIN (old, new send)
  - Forgot/reset pin by email/phone/username
  - Reset PIN using security questions
- [пример](https://fi5t.xyz/posts/pin-code-authentication-rfc/)

#### Системная валидация PIN WebAuthn

На уровне устройств по протоколу [WebAuthn](../../../technology/protocols.integration/webauthn.md), FIDO2\CTAP2 (авторизация в системной форме)

## Технологии

- [IAM](../../system.class/iam.md#технологии)
  - [ADFS](../../../technology/middleware/iam/iam.adfs.md)
  - [KeyCloak](../../../technology/middleware/iam/iam.keycloak.md)
