# TLS Termination

## Зачем

- Оптимизация нагрузки на бэкенды
  - Шифрование/дешифрование TLS требует ресурсов. Перенос этой задачи на прокси снижает нагрузку на бэкенд-серверы.
- Централизованное управление сертификатами
  - Легче управлять сертификатами, обновлять их и обеспечивать их корректность на одном узле, чем на каждом бэкенде.
- Гибкость в маршрутизации
  - Reverse proxy (например, Nginx, HAProxy, Traefik) может принимать HTTPS-трафик, расшифровывать его и направлять на нужные серверы, применяя балансировку нагрузки, кэширование и другие функции.
- Инспекция и безопасность
  - Если трафик шифрован end-to-end, его сложнее анализировать на предмет угроз. При TLS Termination можно проводить IDS/IPS анализ, фильтрацию, DLP и другие проверки.

Чтобы снизить риск [MiTM](../../ability/mitm.md) применяется:

- End-to-End TLS (шифрование до backend-сервера, без расшифровки на proxy)
  - Плюсы:
    - Максимальная защита от MITM — трафик остается зашифрованным даже внутри сети компании.
    - Безопасность backend-сервисов — атакующему сложнее перехватить или изменить данные.
    - Соответствие требованиям безопасности — многие регуляции (GDPR, PCI DSS) требуют e2e-шифрования.
  - Минусы:
    - Высокая нагрузка на backend — серверу приходится самостоятельно расшифровывать каждое соединение.
    - Сложнее инспектировать трафик — WAF, DLP и IDS-системы не могут анализировать зашифрованные данные.
    - Усложненное управление сертификатами — каждый backend-сервис должен иметь свой актуальный сертификат.
    - Не работает маршрутизация по url:
      - При E2E TLS Nginx __не расшифровывает запросы__, а просто __проксирует__ их в зашифрованном виде на backend. 
        - может маршрутизировать запросы по
          - __Host (SNI)__ TCP-level SNI Routing
          - __URI__ если используется __HTTP/2 ALPN Proxying__
        - Есть вариант L7 (URL-based) маршрутизация — __Только с Terminate + Reencrypt__
          - Если нужно маршрутизировать по URL (например, /api → backend1, /auth → backend2), Nginx должен расшифровать TLS (TLS Termination), а затем повторно зашифровать (TLS Re-encryption)
          - Позволяет маршрутизировать по URL, но требует расшифровки запроса
          - __Не является чистым E2E TLS__, так как __Nginx видит HTTP-запросы__

- Если важна __защита__ от MITM, лучше использовать End-to-End TLS.
- Если важна __оптимизация производительности и анализ трафика__, выбирают TLS Termination, но с защитой сети (например, __mTLS между proxy и backend__).
  - mTLS между proxy и backend — это надежная защита от MITM-атак, так как обе стороны должны предъявить доверенные сертификаты. Использование cert-manager и Istio позволяет автоматизировать управление сертификатами в Kubernetes.
