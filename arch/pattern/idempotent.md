# Идемпотентность

Проблема:

- [Гонки сообщений, запросов изменения, чтения](https://habr.com/ru/post/442762/)
- Типичны для распределенных систем: сетевые ошибки происходят регулярно, железо регулярно выходит из строя, таймауты, перезапросы, дубли

Решение:

- Идемпотентным называют такой метод API, повторный вызов которого не меняет состояние. НО: результат идемпотентного вызова может меняться.
- Использования уникального ключа идемпотентности для каждой транзакции
  - В ИС потребителе ключ идемпотентности генерится.
  - Ключ идемпотентности обязательно создавать в формате GUID. Рекомендуется [версия 4](https://www.uuidtools.com/v4).
  - Чтобы детерминировано определить ключ идемпотентности как для изначального сообщения, так и для повторно обработанного, можно использовать хеш его содержимого или хеш 
  уникальных для сообщения полей.
  - На сервере следует проверять, что параметры входящего запроса совпадают с параметрами существующего заказа с таким же ключом идемпотентности. Например, AWS отдает ошибку [IdempotentParameterMismatch в таком случае](https://habr.com/ru/post/442762/).
  - На сервере ключ идемпотентности инсертится в базу в поле, на котором есть ограничение базы данных по уникальности. Если это ограничение не дало сделать инсерт, то отдавать ошибку ([HTTP status](../../api/api-http-status.md) 409). 
- REST HTTP method
  - GET всегда
  - POST - клиент должен контролировать повторные запросы, если не получил ответа
  - PUT - если клиент не получил ответа на запрос, просто направляет повторно
  - Прокси-серверы могут не повторять POST и PATCH запросы при ошибках, тогда как GET и PUT могут повторить.








