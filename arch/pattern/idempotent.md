# Идемпотентность

Проблема:

- [Гонки сообщений, запросов изменения, чтения](https://habr.com/ru/post/442762/)
- Типичны для распределенных систем: сетевые ошибки происходят регулярно, железо регулярно выходит из строя, таймауты, перезапросы, дубли

Решение:

- Идемпотентным называют такой метод API, __повторный вызов которого не меняет состояние ресурса\сущности__. НО: __результат идемпотентного вызова может меняться__.
- Использования уникального ключа идемпотентности для каждой транзакции
  - В ИС потребителе **ключ идемпотентности** генерится.
  - Ключ идемпотентности обязательно создавать в формате GUID. Рекомендуется [версия 4](https://www.uuidtools.com/v4).
  - Чтобы детерминировано определить ключ идемпотентности как для изначального сообщения, так и для повторно обработанного, можно использовать хеш его содержимого или **хеш** уникальных для сообщения полей.
  - На сервере следует проверять, что параметры входящего запроса совпадают с параметрами существующего заказа с таким же ключом идемпотентности. Например, AWS отдает ошибку [IdempotentParameterMismatch в таком случае](https://habr.com/ru/post/442762/).
  - На сервере ключ идемпотентности инсертится в базу в поле, на котором есть **ограничение базы данных по уникальности**. Если это ограничение не дало сделать инсерт, то отдавать ошибку ([HTTP status](../../api/api-http-status.md) 409). 
- REST HTTP методы 
  - [идептоментны всегда](https://github.com/Microsoft/api-guidelines/blob/master/Guidelines.md#74-supported-methods): GET, PUT, DELETE
  - необходимо реализовать идептоментность
    - POST - клиент должен контролировать повторные запросы, если не получил ответа
    - PATCH - если клиент не получил ответа на запрос, просто направляет повторно
  - Прокси-серверы могут не повторять POST и PATCH запросы при ошибках, тогда как GET и PUT могут повторить.
- Чтобы гарантировать [идемпотентность MQ](https://www.russianblogs.com/article/3133962710/), необходимо гарантировать, что потребители не будут повторно использовать одно и то же сообщение.






