# Распил монолита

- [Распил монолита](#распил-монолита)
	- [Зачем](#зачем)
	- [Приоритеты для распила](#приоритеты-для-распила)
	- [Извлечение сервисов](#извлечение-сервисов)
		- [Паттерны](#паттерны)
		- [Рефакторинг кода](#рефакторинг-кода)
		- [Рефакторинг БД](#рефакторинг-бд)
		- [Рефакторинг интеграций](#рефакторинг-интеграций)
			- [Рефакторинг синхронного взаимодействия](#рефакторинг-синхронного-взаимодействия)
			- [Рефакторинг асинхронного взаимодействия (шины сообщений)](#рефакторинг-асинхронного-взаимодействия-шины-сообщений)
		- [Рефакторинг авторизации](#рефакторинг-авторизации)
	- [Модульный монолит](#модульный-монолит)

Паттерны распила [монолита](../style/monolit.md) на [MSA](../style/msa.md)

## Зачем

- __Ускорение разработки__. Если согласно плану какая-то часть вашего приложения будет активно развиваться на протяжении следующего года, разработку можно ускорить путем извлечения ее в сервис.
- Решение проблем с __производительностью, масштабируемостью и надежностью__. Если определенная часть вашего приложения ненадежна или имеет проблемы с производительностью или масштабируемостью, будет полезно преобразовать ее в сервис.
- Возможность извлечь какие-то другие сервисы. Иногда из-за __зависимостей между модулями__ извлечение одного сервиса упрощает извлечение другого.

Альтернатива - модульный монолит.

## Приоритеты для распила

Что [вынести в первую очередь](http://agilemindset.ru/от-монолита-к-микросервисам-в-разумно/) в сервис\модуль, а что можно оставить?

- Бизнес-критичность
- Интенсивность изменений
- Инновационность
- Объем транзакций (обращений)  
- Уровень зависимостей
- Утилизация ресурсов
- Сложность сервиса  

Имеет смысл извлечь сервис, __функции, которого постоянно эволюционируют и имеют критическое значение с точки зрения бизнеса__. Если извлечение не приносит существенной выгоды, не стоит тратить на него время.

## Извлечение сервисов

ФБ - функциональный блок - бизнес-возможность - поддомен [DDD](ddd.md).

- нужно решить, как разбить __доменную модель монолита на отдельные модели (ФБ)__, одна из которых будет принадлежать сервису.
- Для вынесения функциональности придется разорвать зависимости
  - объектные ссылки, и, возможно, __разделить существующие классы__
  - модифицировать __[структуру базы данных](#рефакторинг-бд)__
- при извлечении сервиса вы разделяете то, что прежде было ACID-транзакциями. Вы должны внимательно __следить за сохранением согласованности__, для этого иногда применяются [повествования Event Sourcing](event.sourcing.md).

### Паттерны

- Паттерн Фикус-удавка - параллельная функциональность с [маршрутизацией запросов](#рефакторинг-интеграций)
	- Выявить зависимости между ФБ
	- Выносить нижестоящие ФБ первыми без зависимостей нижестоящих
	- Состояние (БД) вынести и возможно потребуется обратно его обновлять
	- Возможность переключения-отката: монолит-сервис
    	- Ограничение: если изменения функционала происходят в сервисе, откат затрудняется, требуется синхронизировать и монолит. В идеале __фриз измненений__.

### Рефакторинг кода

- Слои приложения разделить: UI-BLL-DAL

### Рефакторинг БД

__методики рефакторинга__ схемы базы данных

- рефакторинг типа «разделение таблицы» (split table), который разбивает одну таблицу на две или больше
- Паттерн __"Совместное использование БД"__ несколькими сервисами
  - минусы: нет сокрытия и изоляция данных, размыто понимание какой сервис какими данными владеет
  - подходит для:
    - статических справочных данных для чтения
    - БД для интеграция нескольких внешних ИС потребителей
- Паттерн __"Представления (проекции view) БД"__ для внешних ИС потребителей
- минусы: единое ядро СУБД между ИС как правило необходимо, иначе проблемы совместимости, скорости (MSSQL2PgSQL и тп)
- Паттерн __"Сервис обертки над БД" (database wrapping service)__
  - подходит где сложно разобрать быстро модель БД и замораживается развитие БД
    - контроль, что скрыто в модели от потребителей
  - минусы: "повязка" временная для постепенного рефакторинга модели БД
- Паттерн __"Интерфейс БД как служба"__
  - Основная БД отображается на отдельную БД на чтение для внешних ИС потребителей
    - механизм отобажения: онлайн CDC (Devezium и тп), пакетный ETL
  - Изменения в основной БД происходят через API
  - минусы: доп расходы на отдельную БД и механизм отображения
    - альтернатива: реплика полная БД, но сокрытия нет и ИС потребители сами следят за изменениями модели БД
  - Отличие от Паттерна "Представления БД", что отдельная БД может быть __на другом тех стеке__
  - подходит для отчетности

### Рефакторинг интеграций

#### Рефакторинг синхронного взаимодействия

- Маршрутизация на API GW
- Трансформация фоматов (SOAP2gRPC, REST2gROC, SOAP2REST и тп)
	- на API GW
    	- минусы: "умный" канал
	- на уровне ИС источника API поддержка обоих форматов

#### Рефакторинг асинхронного взаимодействия (шины сообщений)

- Маршрутизация основанная на содержимом сообщений
  - минусы: канал - шина сообщений становится "умной"
- Селективное потребление
  - минусы: доработка монолита для игнорирования сообщений

### Рефакторинг авторизации

## Модульный монолит

  - Изоляция модулей
  - Не обязательно обмен __доменными событиями__ между модулями (на следующей фазе)
  - Отдельные схемы БД
  - Сохраняем БД транзакции и ссылки между таблицами
