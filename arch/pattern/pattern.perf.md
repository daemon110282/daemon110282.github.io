# Производительность

- [Производительность](#производительность)
  - [Характеристики производительности](#характеристики-производительности)
  - [Паттерны](#паттерны)
    - [Приложение back-end](#приложение-back-end)
    - [Приложение front-end](#приложение-front-end)
    - [API](#api)
    - [БД](#бд)
      - [SQL](#sql)
    - [Сеть](#сеть)
  - [Метрики](#метрики)
  - [Требования пример](#требования-пример)

Ключевая метафора для понимания производительности - это **конвейер задач**. Которые прокачиваются через **трубу**. Количество и последовательность задач в конвейере определяются требованиями заказчика и техническими решениями программиста.
Пропускная способность трубы определяется ее **шириной (Bandwitch)** и **длиной(Latency)**. Которые в свою очередь определены лежащим в фундаменте системы Hardware/Software.
Пропускная способность системы в целом определяется тем, сколько задач можно прокачать через трубу в единицу времени. Здесь важны т.е., **ширина**(объем используемого CPU/RAM/IO) и **длина**(продолжительность выполнения) задач.

Производительность может быть повышена следующими способами:

- Сокращением "длины" и/или "ширины" задач
- Выполнением задач параллельно, ЕСЛИ в "трубе" есть для этого место.
- Исключением задач из конвейера - выполнением их асинхронно.

## Характеристики производительности

Характеристика - Единицы измерения

- Нагрузка на CPU - Процент
- Использование физической/виртуальной памяти	- Байты, килобайты, мегабайты, гигабайты
- Время выполнения среднее\макс для 90% запросов- Миллисекунды
- Сетевые операции, канал забит -	Количество, частота следования в секунду, объем трафика bandwidth, какие урлы сколько трафика генерируют, трафик на сетевых интерфейсах
- Дисковые операции СХД	- Количество, частота следования в секунду
- Время отклика\задержки Latency - Миллисекунды
- параметры [виртуалки VMWare](https://habrahabr.ru/post/259087/)
- redis память много, операции чтения
- [балансировщик](../ability/load.balancing.md) прокси, nginx, netscaler - как балансировка на ноды работает, время ответ нод балансировщику
- Исключительные ситуации errors, HTTP Error 503.2 — Service Unavailable - Количество, частота следования в секунду
- Обращения к базе данных -	Количество обращений, частота следования в секунду
- "Сколько операций может выполнить система за определенный период времени? (пропускная способность)
- "Сколько операций могут быть выполнены одновременно? (параллелизм)
- Макс пользователей
- Число вызовов в сутки / в ЧПН
- Объем запроса, Объем ответа
- Попадания в кеш	Количество, частота попаданий в секунду
- Ошибки обращений к страницам диска - Количество, частота следования в секунду
- Конкуренция - Количество, частота следования в секунду
- Выделение блоков памяти - Количество байтов, количество объектов, частота следования в секунду
- Сборка мусора - Количество, частота следования в секунду, продолжительность, % от общего времени выполнения
- Время запуска - Миллисекунды
- Сколько резервной мощности требуется системе для обеспечения роста нагрузки? (запас ресурсов)
- Сколько исключений система генерит под нагрузкой? (частота ошибок)

TODO
- [UMP](https://airtable.com/embed/shrj9QkstRkVlFW0i/tblzJXJYUlj4aCHaJ)
- http://sixrevisions.com/web-performance/improve-website-speed-02/

## Паттерны 

### Приложение back-end

- [кэш](pattern.cache.md) вывода, данных (sqldependency)
- денормализация
- Масштабирование: горизонтальный ( рядом новый сервер), вертикальные (ядер, памяти и ТП)
- Решение принимаем по каждому виду данных/бизнес сущности отдельно.
- Ищем баланс с учетом
  - размера данных
  - стоимости их вычисления/чтения с HDD
  - вероятности их повторной востребованности
  - размера, который они занимают в кеше/частоты изменения данных/того
  - насколько “болезненно” будет для пользователя получение “устаревших” данных из кеша.

### API

- API [Benchmark](https://github.com/tsenart/vegeta)

### Приложение front-end

- JavaScript
  - существует инструмент под названием Navigation Timing API, который позволяет собирать на стороне клиента данные по скорости страницы, продолжительности DNS resolve, передачи данных по сети, работы на Backend’е, отрисовки страницы.
  - Google [Web Vitals](https://web.dev/i18n/en/vitals/)

### БД

- [CQRS](pattern.cqrs.md) - чтение и запись из разных бд
- Master-slave, Logshipping
- Шардирование (CITUS)
  - Вертикальный - партиционирование-секционирование, одну таблицу на несколько таблиц в одной субд
  - Горизонтальный - таблицы на разных субд
- Репликация
- Кластеризация
- [Уровень изоляции данных](store.../store.isolation.level.md)

#### MS SQL

Способ анализа производительности SQL Server:

1. Записать с помощью SQL Server Profiler (или AnjLab.SqlProfiler) запросы, исполняемые при запуске функции (например редактирование анкеты)
2. Добавить метки времени в начало и в конец запроса CONVERT(nvarchar(30), GETDATE(), 126)
3. Запустить скрипт на локальном сервере и на сервере разработчика
4. Вычислить времени выполнения на локальном сервере и на сервере разработчика (ручным способом)/ Результаты позволяют уверенно говорить о причинах медленной загрузки страниц (например редактирование анкеты) в браузере.

Стратегии оптимизации запросов:

- можно использовать индексы, другие варианты запроса, сохранение промежуточных результатов.	Выбор варианта оптимизации зависит от конкретного случая. При этом могут быть использованы сразу несколько подходов.
- Не все индексы одинаково полезны. При разработке индексов необходимо учитывать их селективность.	
- Для проверки быстродействия запроса:	SET STATISTICS TIME ON
- Для проверки статистики ввода/вывода:	SET STATISTICS IO ON
- Для вывода плана запроса:	SET STATISTICS XML ON

TODO

- http://f1incode.blogspot.com/2011/07/i_28.html	
- http://f1incode.blogspot.com/2011/08/performance-testing-part-2.html
- http://www.itcommunity.ru/Msgs/default.aspx?MessageID=60	
- http://msmvps.com/blogs/irinanaumova/archive/2011/05/06/1792775.aspx	
- http://www.mssqltips.com/tip.asp?tip=1039	
- [Оценка производительности SQL Server](http://www.interface.ru/home.asp?artId=6968)
- [Microsoft: Мониторинг и настройка производительности](http://www.sql.ru/forum/actualthread.aspx?tid=858780)

### Сеть

- [Windows Distributed File System (DFS) и Replication](https://windowsnotes.ru/activedirectory/distributed-file-system-arxitektura-i-bazovye-ponyatiya/)
  - A distributed file system (DFS) is a file system with data stored on a server. The data is accessed and processed as if it was stored on the local client machine.
  - The DFS makes it convenient to share information and files among users on a network in a controlled and authorized way. The server allows the client users to share files and store data just as if they are storing the information locally. However, the servers have full control over the data, and give access control to the clients.
- Каналы связи вертикальное масштабирование [дублирование каналов связи, защита](https://systempb.ru/company/our-articles/vysokie-skorosti-sovremennykh-tsod-kak-vozmozhnosti-stanovyatsya-ogranicheniyami-i-chto-s-etim-delat/)
- [топология сети](http://citforum.ru/nets/optimize/locnop_02.shtml) и используемое коммуникационное оборудование

## Метрики

- Client Metrics. Данные метрики сконцентрированы на измерении производительности клиентских приложений. Например, как долго клиентское приложение выполняет действия локально и обрабатывает ответ от серверной части. Эти метрики покрывают такие данные, как объем используемой памяти и загрузку CPU. На мобильном устройстве высокая загрузка CPU и частое использование сети может привести к уменьшению срока службы батареи, а использование слишком большого объема памяти вообще может помешать приложению запуститься.
- Business Metrics. Сюда включаются данные, определяющие бизнес-процессы. Они касаются деятельности конечных пользователей. Эти показатели должны включать ключевые бизнес-операции, которые выполняет система
- Application Metrics. Данные метрики сосредоточены на измерении активности и производительности прикладного уровня (исходный код приложения, фреймворк, среда исполнения, например .NET Framework, ASP.NET, CLR, и т.п.). Цель этих метрик – помочь вам исследователь поток выполнения вашего приложения при большом количестве параллельных запросов, проанализировать потребляемые ресурсы и оценить вероятность проблем с производительностью
- System Metrics. Это данные о производительности низкого уровня (уровень базовой инфраструктуры). Они обычно нацелены на ключевые показатели эффективности, связанные с памятью, сетевой утилизацией, активностью диска, использованием процессора
- Service Metrics. Сюда относятся данные, связанные с производительностью внешних сервисов, таких как Azure Storage, инфраструктурой обмена сообщений, внешним кэшем, БД и другими внешними сервисами, которые ваше приложение может использовать. Эти данные не отражают чистую производительность внешних сервисов, а всего лишь содержат информацию об исполнении запросов, которые ваша система им отправляет.

Примеры метрик:

- Сколько операций может выполнить система за определенный период времени? (пропускная способность)
- Сколько операций могут быть выполнены одновременно? (параллелизм)
- Как долго система выполняет операцию? (время отклика/задержка)
- Сколько резервной мощности требуется системе для обеспечения роста нагрузки? (запас ресурсов)
- Сколько исключений система генерит под нагрузкой? (частота ошибок)
- Макс пользователей
- Максимальное время загрузки страницы (300мс отлично)
- CPU User time
- CPU System time (Может  показывать на неэффективный ввод-вывод, т.е. слишком большое количество мелких операций)
- HDD Number of reads
- HDD Number of writes
- HDD bytes readed
- HDD bytes written
- Network Number of reads
- Network number of writes
- Network bytes readed
- Network bytes written
- RAM Private space used by application
- RAM Shared space used by application
- RAM Number of page faults (насколько локализованы данные приложения в памяти?)

## Требования пример

- какой объем памяти выделен будет на работу приложения на хостинге?
- какой объем памяти допустимо использовать на ПК клиента для отображения отчета (максимум как мы понимаем 1ГБ- память на работу ОС XP, т.е. около 800Мб)?
- какая макс скорость канала будет от ПК пользователя до веб-сервера?
- какое время ожидания отчета в принципе допустимо для "очень большого отчета"? предлагаю определиться именно с параметрами "очень большого отчета"
- Здесь необходимо сначала дать определения большого и не большого отчета, а то слишком субъективные оценки.
- Обычный Текстовый 150 строк * 12 столбцов 12 сек.
- Большой Текстовый отчет за 3 года не более 2 мин. (ориентировочно 20000 строк*15 столбцов)
- Обычный Числовой/Графический 1 минута 3-4 группировки 200 строк * 100 столбоцов
- Максимальный Числовой/Графический максимальная скорость построения отчета – 2 минуты.
