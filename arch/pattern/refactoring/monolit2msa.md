# Распил монолита

- [Распил монолита](#распил-монолита)
  - [Зачем](#зачем)
  - [Организационные изменения](#организационные-изменения)
  - [Приоритеты для распила](#приоритеты-для-распила)
  - [Извлечение сервисов](#извлечение-сервисов)
    - [Паттерны](#паттерны)
    - [Рефакторинг](#рефакторинг)
      - [Рефакторинг авторизации](#рефакторинг-авторизации)

Паттерны распила [монолита](../../style/monolit.md) на [MSA](../../style/msa.md)

## Зачем

- __Ускорение разработки__. Если согласно плану какая-то часть вашего приложения будет активно развиваться на протяжении следующего года, разработку можно ускорить путем извлечения ее в сервис.
- Решение проблем с __производительностью, масштабируемостью и надежностью__. Если определенная часть вашего приложения ненадежна или имеет проблемы с производительностью или масштабируемостью, будет полезно преобразовать ее в сервис.
- Возможность извлечь какие-то другие сервисы. Иногда из-за __зависимостей между модулями__ извлечение одного сервиса упрощает извлечение другого.

Альтернатива - [модульный монолит](../../style/monolit.modul.md).

## Организационные изменения

- Сервисы лучше писать [не монолитчику](https://habr.com/ru/articles/508856/) - он и так довел монолит до текущего состояния
- С недоверием относитесь к переиспользованию функционала? Наоборот, любой функционал должен дублироваться.

## Приоритеты для распила

Что [вынести в первую очередь](http://agilemindset.ru/от-монолита-к-микросервисам-в-разумно/) в сервис\модуль, а что можно оставить?

- Метрики для приоритизации:
	- Бизнес-критичность
	- Интенсивность изменений
	- Инновационность
	- Объем транзакций (обращений)  
	- Уровень зависимостей
	- Утилизация ресурсов
	- Сложность сервиса  
- Имеет смысл извлечь сервис, __функции, которого постоянно эволюционируют и имеют критическое значение с точки зрения бизнеса__. Если извлечение не приносит существенной выгоды, не стоит тратить на него время.
- Возможна высокая трудоемкость распила всего монолита и лучше делать __только новые сервисы вокруг монолита__, а [монолит не распиливать](https://habr.com/ru/companies/vk/articles/519354/).
- Существующие модули слабо зависимые и часто изменяемые

## Извлечение сервисов

ФБ - функциональный блок - бизнес-возможность - поддомен [DDD](../system.design/ddd.md).

- нужно решить, как разбить __доменную модель монолита на отдельные модели (ФБ)__, одна из которых будет принадлежать сервису
- Для вынесения функциональности придется разорвать зависимости
  - объектные ссылки, и, возможно, __разделить существующие классы__
  - модифицировать __[структуру базы данных](monolit2msa.db.md)__
- при извлечении сервиса вы разделяете то, что прежде было ACID-транзакциями. Вы должны внимательно __следить за сохранением согласованности__, для этого иногда применяются
  - [повествования Event Sourcing](../integration/event.sourcing.md)
  - [Рефакторинг БД](monolit2msa.db.md)
- Чтобы __ограниченные контексты отделять__ друг от друга и начать процесс выделения микросервисов из монолитного решения, мы использовали такой подход, как [создание внутри приложения внешних API](https://habr.com/ru/companies/raiffeisenbank/articles/458404/)

### Паттерны

- Что __извлекать первым: код или БД__?
  - если можно изменять монолит, БД
  - иначе - код
- [Feature Toogle](../feature.toggle.md) typical workflow:
  - Identify a __piece of the monolith__ functionality to migrate to a microservice.
  - __Wrap__ the functionality with a __feature flag__. Re-deploy the monolith.
  - Build and deploy the microservice
  - Test the microservice
  - Then ok, __disable the feature__ on the monolith by switching the feature flag
  - __Repeat__ until the migration is complete
- Провести [нагрузочное тестирование](../../../technology/benchmark.md)
- Для __реверс-инжиниринга__: gor

### Рефакторинг

Делится на:

- [Рефакторинг кода](monolit2msa.code.md)
- [Рефакторинг БД](monolit2msa.db.md)
- [Рефакторинг интеграций](monolit2msa.api.md)
- Рефакторинг авторизации

#### Рефакторинг авторизации

- Cookie Based авторизация на основе сессий расширяется параметром - __JWT access токен__ с доступом пользователя, который на уровне API GW передается в Header Authorization: Bearer {{token}}
	- Как генерировать access token?
	- Как валидировать access token, если нет Сервиса Авторизации?
	- Роли на уровне сервиса? Централизован ролевой доступ в Сервисе Авторизаций?
	- 2й этап - Сервис Авторизации
