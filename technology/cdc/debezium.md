# Debezium

- [Debezium](#debezium)
	- [Зачем](#зачем)
		- [Поддерживает Debezium MS SQL?](#поддерживает-debezium-ms-sql)
		- [Debezium позволяет гибко настроить параметры маппинга загрузки данных из источника в получателя?](#debezium-позволяет-гибко-настроить-параметры-маппинга-загрузки-данных-из-источника-в-получателя)

## Зачем

- [CDC](../cdc.md) решение
- [Audit logs](https://debezium.io/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/)
- MS SQL
	- с версии 1.6.0, Debezium включает поддержку CDC [для MS SQL Server](https://debezium.io/documentation/reference/1.6/connectors/sqlserver.html)
- Предоставляет __гибкую настройку параметров маппинга загрузки данных из источника в получатель__. 
	- определить способы __трансформации, фильтрации, переименования или изменения формата данных__
	- Debezium использует Apache Kafka Connect framework, который предлагает различные способы преобразования данных с помощью __конвертеров (converters)__
		- Конвертеры позволяют вам задать правила преобразования данных при передаче из одной системы в другую. 
			- Например, вы можете использовать `org.apache.kafka.connect.transforms.ExtractField` для выбора только определенных полей из сообщений
			- или `org.apache.kafka.connect.transforms.Cast` для преобразования типов данных.
	- есть возможности использования своего __собственного кода для более сложных преобразований данных__. Вы можете создать собственный класс трансформации (Transformer) и указать его в настройках коннектора. Это дает вам полный [контроль над процессом преобразования данных](https://debezium.io/documentation/reference/1.6/configuration/transforms.html)
- Логи изменения схемы БД

## Паттерны

- писать данные в формате [AVRO вместо JSON](https://habr.com/ru/companies/flant/articles/523510/)
- Миграции
	- [Снимки (snapshots)](https://habr.com/ru/companies/redhatrussia/articles/573720/) - может сделать снимок текущего состояния исходной базы данных, который потом можно использовать для массового импорта данных. Как только снимок будет сделан, Debezium начнет стримить изменения для синхронизации целевой системы.
	- Debezium Server, готовое приложение для организации обмена данными при их миграции или модернизации существующих систем.

## Отказоустойчивость

- Отказ Kafka Connect
	- в распределенном режиме, для этого необходимо нескольким воркерам задать одинаковый group.id
- Потеря связности с Kafka-кластером. 
	- Коннектор просто остановит чтение на позиции, которую не удалось отправить в Kafka, и будет периодически пытаться повторно отправить её, пока попытка не завершится успехом.
- Недоступность источника данных
	- По умолчанию это __16 попыток с использованием exponential backoff__
	- В случае с PostgreSQL данные не пропадут, т.к. использование __слотов репликации не даст удалить WAL-файлы__, не прочитанные коннектором. 
		- Минус: если на продолжительное время будет нарушена сетевая связность между коннектором и СУБД, есть вероятность, что __место на диске закончится, а это может может привести к отказу СУБД целиком__.
