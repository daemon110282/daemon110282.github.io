# Debezium

- [Debezium](#debezium)
	- [Зачем](#зачем)
		- [Поддерживает Debezium MS SQL?](#поддерживает-debezium-ms-sql)
		- [Debezium позволяет гибко настроить параметры маппинга загрузки данных из источника в получателя?](#debezium-позволяет-гибко-настроить-параметры-маппинга-загрузки-данных-из-источника-в-получателя)

## Зачем

- [CDC](../cdc.md) решение
- [Audit logs](https://debezium.io/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/)
- MS SQL
	- с версии 1.6.0, Debezium включает поддержку CDC [для MS SQL Server](https://debezium.io/documentation/reference/1.6/connectors/sqlserver.html)
- Предоставляет __гибкую настройку параметров маппинга загрузки данных из источника в получатель__. 
	- определить способы __трансформации, фильтрации, переименования или изменения формата данных__
	- Debezium использует Apache Kafka Connect framework, который предлагает различные способы преобразования данных с помощью __конвертеров (converters)__
		- Конвертеры позволяют вам задать правила преобразования данных при передаче из одной системы в другую. 
			- Например, вы можете использовать `org.apache.kafka.connect.transforms.ExtractField` для выбора только определенных полей из сообщений
			- или `org.apache.kafka.connect.transforms.Cast` для преобразования типов данных.
	- есть возможности использования своего __собственного кода для более сложных преобразований данных__. Вы можете создать собственный класс трансформации (Transformer) и указать его в настройках коннектора. Это дает вам полный [контроль над процессом преобразования данных](https://debezium.io/documentation/reference/1.6/configuration/transforms.html)
- Логи изменения схемы БД

## Плюсы и минусы

Плюсы:

- Изменения приходят полностью. Это удобно — известно, как выглядела запись до изменений и какой вид имеет сейчас.
- Работа через WAL. Чтение записей выполняется через WAL, который выступает промежуточным звеном. Благодаря этому, нагрузка на источник не увеличивается, достигается высокая скорость репликации и низкий лаг.
- [Гарантированная консистентность данных](https://habr.com/ru/companies/vk/articles/719112/). Согласованность достигается за счет использования репликационных протоколов баз данных.

Минусы:

- Java

## Паттерны

- писать данные в формате [AVRO вместо JSON](https://habr.com/ru/companies/flant/articles/523510/)
- Миграции
	- [Снимки (snapshots)](https://habr.com/ru/companies/redhatrussia/articles/573720/) - может сделать снимок текущего состояния исходной базы данных, который потом можно использовать для массового импорта данных. Как только снимок будет сделан, Debezium начнет стримить изменения для синхронизации целевой системы.
	- Debezium Server, готовое приложение для организации обмена данными при их миграции или модернизации существующих систем.
- Лаг репликации
	- [Батчинг](https://habr.com/ru/companies/vk/articles/719112/)

### Отказоустойчивость

- Debezium хранит оффсеты — отметки о прочтении записей — в файле, который легко удалить, или в Kafka, которая может быть недоступна.
- Отказ Kafka Connect
	- в распределенном режиме, для этого необходимо нескольким воркерам задать одинаковый group.id
- Потеря связности с Kafka-кластером. 
	- Коннектор просто остановит чтение на позиции, которую не удалось отправить в Kafka, и будет периодически пытаться повторно отправить её, пока попытка не завершится успехом.
- Недоступность источника данных
	- По умолчанию это __16 попыток с использованием exponential backoff__
	- В случае с PostgreSQL данные не пропадут, т.к. использование __слотов репликации не даст удалить WAL-файлы__, не прочитанные коннектором. 
		- Минус: если на продолжительное время будет нарушена сетевая связность между коннектором и СУБД, есть вероятность, что __место на диске закончится, а это может может привести к отказу СУБД целиком__.

## Архитектура

Три [варианта разворачивания](https://for-each.dev/lessons/b/-debezium-intro):

- Apache Kafka Connect
- Debezium Server - автономный сервер без Kafka Connect
- Debezium Embedded  - встроить его в код нашего приложения в виде библиотеки- deprecated

### Debezium Server

Плюсы: 

- Есть готовые сборки — все дистрибутивы можно просто скачать с сайта
- Легко добавить новые source-коннекторы, в том числе работать с собственными
- Конфигурация очень простая: достаточно в конфигурационном файле указать БД-источник, БД-приёмник и параметры подключения
- Инструмент позиционируют как решение для Kubernetes, поэтому его легко масштабировать с помощью k8s
- Позволяет добавлять [своё хранилище оффсетов](https://habr.com/ru/companies/vk/articles/719112/)

Минусы:

- Сложность добавления своего sink-коннектора: надо указывать зависимости и вносить изменения в конфигурационный файл.
- При каждом изменении sink-коннектора надо пересобирать дистрибутив или коннектор.
- Из коробки оффсеты хранятся в файле, в Kafka или в Redis — как и в случае с прототипом это не лучший вариант.