# Prometheus

- [Prometheus](#prometheus)
  - [Зачем](#зачем)
  - [Плюсы-минусы](#плюсы-минусы)
  - [Модель данных](#модель-данных)
  - [PromQL](#promql)
    - [Функции](#функции)
  - [Deployment](#deployment)

## Зачем

Технология для [хранилищ данных](../../arch/system.class/store.md).

![arch](https://prometheus.io/assets/architecture.png)

- сбор метрик по __pull модели__
- [Prometeus Client JS](https://github.com/weaveworks/promjs)
- это [база данных временных рядов](https://slurm-io.turbopages.org/slurm.io/s/tpost/egiyf928zy-polnoe-rukovodstvo-po-prometheus)
- хранит метрики, агрегированные за период времени
- Alerts отправляет в AlertManager
  - Группировка
  - Приостановка уведомлений пока исправляется
- [PromQL](https://prometheus.io/docs/prometheus/latest/querying/examples/)
![schema](https://static.tildacdn.com/tild3932-3264-4264-a430-386464666565/_4.png)
- PushGateway для сбора метрик от периодических процессов (cron jobs например) по __push модели__

## Плюсы-минусы

Плюсы

- Простая установка (один файл)

Минусы

- Не расчитан на длительное хранение, как например [VictoriaMetrics](./victoriametrics.md))
- Высокий порог входа

## Модель данных

- __Инструментирование__ — это еще одна важная часть Prometheus. Вы инструментируете приложения, прежде чем извлекать из них данные.
- Prometheus предлагает __экспортеры__, с помощью которых можно мониторить целевые объекты.
- Метрика — это __временной ряд__, то есть набор значений во времени. [Виды, методики по метрикам](../../arch/ability/performance/performance.metric.md).  
  - примеры: Кол-во задач, Кол-во запросов
- набор лейблов (теги) key-value
  - примеры
	- instance
	- evn
	- job
- значение метрики
![data model](https://static.tildacdn.com/tild6163-3136-4134-b933-396663633530/_5.png)

[Типы метрик](https://slurm.io/tpost/egiyf928zy-polnoe-rukovodstvo-po-prometheus):

- __Счетчик Count__ - счетчик может __только увеличивать или обнулять число__
  - Примеры
    - Кол-во задач в состоянии Завершена\Кол-во задач в состоянии В очереди
    - Кол-во запросов
    - Кол-во ошибок
- __Измерители Gauge__ - со временем __могут уменьшаться__
  - Примеры
    - количество обрабатываемых запросов прямо сейчас
    - занятая память
    - свободное место на диске
- __Гистограмма Histogram__ - агрегация чего-то самим приложением, когда нам интересно знать [распределение величин по заранее определенным группам (buckets)](https://habr.com/ru/company/tochka/blog/685636/)
  - Гистограмма считает количество попаданий в какую-то группу, то есть __запоминает счетчики, а не сами значения__
  - le — просто лейбл, который генерируется из наших бакетов. Означает "less than or equal", то есть <=
  - Примеры
    - [длительность HTTP-запросов](https://habr.com/ru/articles/645231/)
    - [Настройка heatmap](https://opstrace.com/blog/grafana-histogram-howto)
    - [Персентиль histogram_quantile](https://grafana.com/blog/2020/06/23/how-to-visualize-prometheus-histograms-in-grafana/)
- __Сводки Summary__ - результат агрегации гистограммы. Она выдает сразу квантили, можно сказать, количественное распределение, когда мы заранее не можем определить бакеты.

## PromQL

Два [вида векторов](https://habr.com/ru/companies/tochka/articles/693834/):

- моментальные - все метрики по последней метке времени
- с [диапазоном времени](https://the-devops.ru/devops/осваиваем-мониторинг-с-prometheus-часть-2-promql-и-ме/)

### Функции

- __sum__ — оператор агрегации, который суммирует значения по группе элементов. Используется для получения общей суммы значений для всех подходящих [временных рядов](https://habr.com/ru/articles/747350/)
- __rate__ — используется для вычисления средней скорости изменения для временных рядов в указанный промежуток времени, как часто определенное событие происходит в течении определенного времени
- __histogram_quantile__ — ищет значение, которое не превышает определенный процент всех запросов. Интерпретировать можно так: «N% всех запросов обрабатывается быстрее, чем это значение»
- __increase__ -

## Deployment

- масштабируется за счет федерации (кластеризации нет)
- [HA](https://habr.com/ru/companies/oleg-bunin/articles/728456/) :  Thanos, Cortex или Mimir
![варианты](https://habrastorage.org/getpro/habr/upload_files/a04/915/5ef/a049155eff8a2d6921e86100584a7919.png)
