# Prometheus

- [Prometheus](#prometheus)
	- [Зачем](#зачем)
	- [Модель данных](#модель-данных)
	- [PromQL](#promql)
		- [Агрегации](#агрегации)
	- [Deployment](#deployment)

## Зачем

- это [база данных временных рядов](https://slurm-io.turbopages.org/slurm.io/s/tpost/egiyf928zy-polnoe-rukovodstvo-po-prometheus)
- хранит метрики, агрегированные за период времени
- [PromQL](https://prometheus.io/docs/prometheus/latest/querying/examples/)
![schema](https://static.tildacdn.com/tild3932-3264-4264-a430-386464666565/_4.png)

## Модель данных

- __Инструментирование__ — это еще одна важная часть Prometheus. Вы инструментируете приложения, прежде чем извлекать из них данные.
- Prometheus предлагает __экспортеры__, с помощью которых можно мониторить целевые объекты.
- Метрика — это __временной ряд__, то есть набор значений во времени. [Виды, методики по метрикам](../../arch/ability/performance.metric.md).  
  - примеры: Кол-во задач, Кол-во запросов
- набор лейблов (теги) key-value
  - примеры
	- instance
	- evn
	- job
- значение метрики
![data model](https://static.tildacdn.com/tild6163-3136-4134-b933-396663633530/_5.png)

[Типы метрик](https://slurm.io/tpost/egiyf928zy-polnoe-rukovodstvo-po-prometheus):

- __Счетчик Count__ - счетчик может __только увеличивать или обнулять число__
  - Примеры
    - Кол-во задач в состоянии Завершена\Кол-во задач в состоянии В очереди
    - Кол-во запросов
    - Кол-во ошибок
- __Измерители Gauge__ - со временем __могут уменьшаться__
  - Примеры
    - количество обрабатываемых запросов прямо сейчас
    - занятая память
    - свободное место на диске
- __Гистограмма Histogram__ - агрегация чего-то самим приложением, когда нам интересно знать [распределение величин по заранее определенным группам (buckets)](https://habr.com/ru/company/tochka/blog/685636/)
  - Гистограмма считает количество попаданий в какую-то группу, то есть __запоминает счетчики, а не сами значения__
  - le — просто лейбл, который генерируется из наших бакетов. Означает "less than or equal", то есть <=
  - Примеры 
    - [длительность HTTP-запросов](https://habr.com/ru/articles/645231/)
    - [Настройка heatmap](https://opstrace.com/blog/grafana-histogram-howto)
    - [Перцентиль histogram_quantile](https://grafana.com/blog/2020/06/23/how-to-visualize-prometheus-histograms-in-grafana/)
- __Сводки Summary__ - результат агрегации гистограммы. Она выдает сразу квантили, можно сказать, количественное распределение, когда мы заранее не можем определить бакеты.

## PromQL

Два [вида векторов](https://habr.com/ru/companies/tochka/articles/693834/):

- моментальные - все метрики по последней метке времени
- с [диапазоном времени](https://the-devops.ru/devops/осваиваем-мониторинг-с-prometheus-часть-2-promql-и-ме/)

### Агрегации

- Среднее арифмитическое значение
  - нельзя просто так брать среднее чего-то на неопределённом интервале и при этом не потерять ничего
- __Медиана__ – это «средний элемент», то есть [буквально в середине массива (если его упорядочить)](https://habr.com/ru/companies/tochka/articles/690814/). У медианы есть такая особенность: половина элементов массива больше либо равна ей, а другая половина элементов — меньше либо равна.
- __Перцентиль__ (Процентиль) - [способ сжать историю наблюдений до одного числа](https://habr.com/ru/companies/tochka/articles/685636/), при этом по пути потерять неудобные для нас данные, чтобы не мешали смотреть на общую картину.
  - 95-й прецентиль — это такое число, что 95% элементов массива меньше или равны этому числу.
    - удобно использовать эту штуку, чтобы описать __большинство элементов массива, при чем степень точности регулируется__: 80%, 95%, 99%, 99.9%, Для чего бывает полезно описывать «большинство из массива»? Чтобы выбросить пики!
  - 95 перцентиль от времени обработки запросов = 5 секунд
    - То есть, большинство (95%) запросов мы обработали за 5 секунд или меньше. А остальные 5% обрабатывались дольше.
    - Можно еще посчитать 99-й перцентиль и сравнить с 95-м, тогда станет понятно, что большинство запросов укладываются в 5 секунд, а подавляющее большинство, скажем, в 6 секунд.
  - [Синонимы](https://habr.com/ru/companies/tochka/articles/690814/)
    - __Квартиль__ это четверти: 25%, 50%, 75%, 100%. То есть бывает первый, второй третий и четвертый квартиль. И еще иногда используют нулевой.
    - __Квантиль__ - это, условно, перцентиль без процентов. Используется в статистике, где бывает удобно указывать абсолютную вероятность, а не в процентах
    - __Дециль__ — это 10%, 20% и т.д.
- __Кардинальность__
- min, max
- __Сэмплирование__ [данных метрик](https://habr.com/ru/companies/dins/articles/490430/) определяет кол-во значений для агрегирования с учетом интервала времени (глубина запроса)

## Deployment

- [HA](https://habr.com/ru/companies/oleg-bunin/articles/728456/) :  Thanos, Cortex или Mimir
![варианты](https://habrastorage.org/getpro/habr/upload_files/a04/915/5ef/a049155eff8a2d6921e86100584a7919.png)